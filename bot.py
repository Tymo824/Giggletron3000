import os
import requests
import zipfile
import io
import discord
from discord import app_commands, FFmpegPCMAudio
from discord.ext import tasks, commands
import random
from datetime import datetime
import asyncio

FFMPEG_PATH = os.path.join("bin", "ffmpeg.exe")

def ensure_ffmpeg():
    """Download ffmpeg.exe automatically if it's missing (for Windows use)."""
    if os.name == "nt" and not os.path.exists(FFMPEG_PATH):
        print("üéß Downloading FFmpeg (first-time setup)...")
        os.makedirs("bin", exist_ok=True)
       url = "https://github.com/eugeneware/ffmpeg-static/releases/download/b5.0.1/ffmpeg-win64-v5.0.1.zip"
        r = requests.get(url, timeout=60)
        if r.status_code != 200:
            print("‚ö†Ô∏è Failed to download FFmpeg!")
            return
        z = zipfile.ZipFile(io.BytesIO(r.content))
        exe_path = None
        for name in z.namelist():
            if name.endswith("ffmpeg.exe"):
                exe_path = name
                break
        if exe_path:
            z.extract(exe_path, "bin")
            new_path = os.path.join("bin", "ffmpeg.exe")
            os.rename(os.path.join("bin", exe_path), new_path)
            print("‚úÖ FFmpeg ready at:", new_path)
        else:
            print("‚ö†Ô∏è Could not find ffmpeg.exe inside the ZIP file.")
    else:
        print("‚úÖ FFmpeg already available or not required on this OS.")

ensure_ffmpeg()
# === Demyx The Jokester Jokes ===
KH_MUSIC_JOKES = [
    # Kingdom Hearts jokes
    "Why did Xemnas start a band? Because he wanted to be the *Nobody* who finally got some fans.",
    "Why did Axel refuse to play guitar? He kept burning through the strings.",
    "Why did Roxas quit drumming? Too many broken hearts ‚Äî and drumsticks.",
    "How many Organization XIII members does it take to change a light bulb? None ‚Äî they prefer the darkness.",
    "Why did Sora get kicked out of the orchestra? He kept trying to conduct with the Keyblade.",
    "Why is Zexion bad at karaoke? He reads the lyrics like they‚Äôre a research report.",
    "Why did Demyx refuse to fight Heartless? He said, 'I only play *soft rock*, not hard mode.'",
    "Why did Kairi join a band? She wanted to find her lost chords.",
    "Why did Goofy start a jazz trio? Because he already mastered the Goof-step.",
    "What‚Äôs Xigbar‚Äôs favorite song? 'Shot Through the Heart.'",
    "Why did Ansem hate rhythm games? He couldn‚Äôt handle the beat of darkness.",
    "Why does Marluxia only listen to vinyl? Because he says petals sound warmer that way.",
    "Why did Larxene get kicked out of the band? Too much shocking stage presence.",
    "Why did Luxord bring cards to the concert? He was ready to deal with the fans.",
    "What do you call Demyx‚Äôs new album? *Water You Waiting For?*",
    "Why did Sa√Øx never finish his song? He always howled before the chorus.",
    "What‚Äôs Xion‚Äôs favorite genre? Covers.",
    "Why did Riku start a rock band? To finally play something light *and* dark.",
    "Why is Sora‚Äôs singing always on key? Because he has a *Keyblade.*",
    "Why doesn‚Äôt Donald play guitar? Because every solo ends in a quack-up.",
    # Music jokes
    "Why did the drummer go to jail? He got caught beating it.",
    "What do you call a musician with no girlfriend? Homeless.",
    "Why did the bassist break up with the keyboardist? Too many treble issues.",
    "Why did the music teacher go to jail? For fingering A minor.",
    "Why did the microphone file a complaint? It was being talked over.",
    "Why don‚Äôt guitarists get along? They‚Äôre always stringing each other along.",
    "Why did the note go to school? To get a little sharp.",
    "Why did Mozart hate chickens? Because they kept saying 'Bach, Bach, Bach!'",
    "Why did the piano break up with the saxophone? It couldn‚Äôt handle the jazz.",
    "Why did the concert end early? The crowd couldn‚Äôt handle the bass drop.",
    "Why did the metronome get promoted? It always kept time.",
    "Why did Beethoven get rid of his chickens? They kept saying 'Bach!'",
    "Why did the DJ get in trouble? He dropped the wrong beat.",
    "Why was the music book sad? It had too many notes.",
    "Why did the singer bring a ladder? To reach the high notes.",
    "Why do musicians make terrible detectives? They always follow the wrong leads.",
    "Why did the note get detention? It was too flat.",
    "Why did the guitarist cross the road? To get to the next gig.",
    "What‚Äôs a skeleton‚Äôs favorite instrument? The trom-bone.",
    "Why did the singer lose his voice? He couldn‚Äôt handle the mic-drop.",
]
# === Demyx's Roasts ===
DEMYX_ROASTS = [
    "Bro, you‚Äôve got less rhythm than a Heartless on roller skates.",
    "You call that an idea? Even my sitar‚Äôs got better thoughts.",
    "I‚Äôd explain it to you, but I only have one brain cell left ‚Äî and it‚Äôs busy tuning my strings.",
    "You‚Äôre the human equivalent of a background NPC in Twilight Town.",
    "I‚Äôve seen Shadows that cast a brighter light than you.",
    "Did you trip over your own Keyblade again? Classic.",
    "You‚Äôd lose a staring contest with a Nobody.",
    "You‚Äôre like a B-tier minigame: confusing, pointless, and unskippable.",
    "If laziness were an art, you‚Äôd be my magnum opus.",
    "You‚Äôd make a great band member ‚Äî if the band was called 'Off Key'.",
    "Your sense of humor‚Äôs as dry as Agrabah.",
    "If brains were munny, you‚Äôd still owe the Moogle.",
    "You remind me of a Gummi Ship ‚Äî slow, loud, and built wrong.",
    "You look like someone pressed randomize on a character creator and just said 'good enough.'",
    "Even Xigbar‚Äôs aim is better than your life choices.",
    "If cringe was darkness, you‚Äôd be the new Ansem.",
    "You‚Äôve got the energy of a D-ranked mission.",
    "You‚Äôd lose a fight against a tutorial enemy.",
    "Are you sure you‚Äôre not part Heartless? Because you‚Äôve got zero soul and too much noise.",
    "I‚Äôd call you a vibe killer, but that would imply you had a vibe to begin with."
]
DEMYX_ROASTS += [
    "You're like a loading screen tip ‚Äî no one reads you and you take too long to show up.",
    "Even Donald‚Äôs magic hits harder than your comebacks.",
    "You‚Äôve got less depth than Atlantica‚Äôs swimming controls.",
    "If confusion were power, you‚Äôd be the next Keyblade Master.",
    "You make Organization XIII look like a comedy troupe.",
    "You couldn‚Äôt organize a save file, let alone a mission.",
    "You‚Äôve got the enthusiasm of a Shadow Heartless at a pep rally.",
    "You remind me of a synth panel ‚Äî loud noises, zero results.",
    "You‚Äôd probably get lost in Traverse Town‚Äôs tutorial section.",
    "Your existence is the emotional equivalent of low battery mode.",
    "If Roxas had two brain cells, you‚Äôd still be missing one.",
    "You look like a failed fusion between Goofy and a memory fragment.",
    "Even the Moogles charge extra to deal with you.",
    "You‚Äôd trip over your own sitar strings trying to look cool.",
    "If sarcasm were XP, I‚Äôd level up every time you talk.",
    "You‚Äôve got less presence than a Nobody at a birthday party.",
    "You make Atlantica‚Äôs rhythm minigame look like a masterpiece.",
    "Even Xaldin‚Äôs wind listens better than you do.",
    "You‚Äôve got more plot holes than Kingdom Hearts‚Äô timeline.",
    "If failure were currency, you‚Äôd own all of Twilight Town.",
    "You could fall asleep during your own roast ‚Äî and still lose.",
    "You‚Äôre like a Gummi Ship ‚Äî somehow both clunky and fragile.",
    "I‚Äôve seen Dusk Nobodies with more rhythm than you.",
    "You‚Äôve got the personality of an unskippable cutscene.",
    "Your sense of timing makes Luxord cry.",
    "You‚Äôd probably lose a staring contest with Roxas‚Äôs blank expression.",
    "You bring less energy than a drained Drive Gauge.",
    "You‚Äôre proof that respawning doesn‚Äôt fix mistakes.",
    "You look like you failed a charisma check in real life.",
    "You‚Äôve got more lag than Atlantica‚Äôs singing segments.",
    "If being awkward were a skill, you‚Äôd be S-rank.",
    "You‚Äôre like Larxene‚Äôs lightning ‚Äî all noise, no precision.",
    "You‚Äôd forget your own roast halfway through it.",
    "You‚Äôve got the same vibe as an out-of-tune boss theme.",
    "You could stand next to Xemnas and still be the least intimidating one there.",
    "Even the Heartless ignore you out of pity.",
    "You‚Äôve got less emotional range than a locked cutscene camera.",
    "You make background NPCs look ambitious.",
    "You‚Äôd get lost walking from one world to the next ‚Äî with a map.",
    "You‚Äôve got 'side quest energy' written all over you.",
    "You talk like you skipped half your own dialogue options.",
    "If effort were XP, you‚Äôd still be level one.",
    "You‚Äôd make a great background noise ‚Äî if silence wasn‚Äôt better.",
    "Even Vexen‚Äôs experiments have more life than your social skills.",
    "You‚Äôre like a Keyblade without a wielder ‚Äî pointless and flashy.",
    "You‚Äôve got less soul than a Nobody cover band.",
    "If cringe could open Kingdom Hearts, you‚Äôd be the chosen one.",
    "You‚Äôd forget your own joke setup mid-sentence.",
    "Even Demyx thinks you‚Äôre too lazy ‚Äî and that‚Äôs saying something.",
    "You‚Äôve got the comedic timing of a frozen synth wave.",
    "You‚Äôd be a perfect Nobody ‚Äî no purpose, no direction, just vibes."
]

# === CONFIGURE THESE ===
CHANNEL_ID = 1423535719648989235  # replace with your channel ID

# === Emotes to rotate ===
JOKE_EMOTES = [
    "<:custom1:972202193576919110>",
    "<:custom2:1406509489506750534>"
]

# === Discord Setup ===
intents = discord.Intents.default()
intents.message_content = True
bot = discord.Client(intents=intents)
tree = app_commands.CommandTree(bot)

def fetch_joke() -> str:
    url = "https://v2.jokeapi.dev/joke/Any?blacklistFlags=racist"
    try:
        r = requests.get(url, timeout=10)
        if r.status_code == 200:
            data = r.json()
            if data["type"] == "single":
                return data["joke"]
            elif data["type"] == "twopart":
                return f"{data['setup']}\n{data['delivery']}"
    except Exception as e:
        print(f"Error fetching joke: {e}")
    return "Couldn't fetch a joke this time üòÖ"

@bot.event
async def on_ready():
    print(f"‚úÖ Logged in as {bot.user}")
    post_joke_of_day.start()
    await tree.sync(guild=None)  # Sync globally
    print("üåê Slash commands synced globally!")

@tasks.loop(minutes=1)
async def post_joke_of_day():
    now = datetime.now()
    if now.hour == 14 and now.minute == 0:
        channel = bot.get_channel(CHANNEL_ID)
        joke = fetch_joke()
        emote = random.choice(JOKE_EMOTES)
        if channel:
            await channel.send(f"üòÇ **Joke of the Day** üòÇ\n{joke}\n{emote}")

@tree.command(name="play", description="Demyx joins your VC and plays a random sound!")
async def play(interaction: discord.Interaction):
    user = interaction.user

    if not user.voice or not user.voice.channel:
        await interaction.response.send_message(
            "üé∏ *Demyx strums his sitar lazily.* 'Uh... maybe join a voice channel first, yeah?'"
        )
        return

    voice_channel = user.voice.channel
    sound_dir = "sounds"
    supported_formats = (".mp3", ".wav", ".ogg")

    if not os.path.exists(sound_dir):
        await interaction.response.send_message(
            "üé∂ *Demyx looks around.* 'Uh, my sound folder‚Äôs missing, man!'"
        )
        return

    sound_files = [f for f in os.listdir(sound_dir) if f.endswith(supported_formats)]
    if not sound_files:
        await interaction.response.send_message(
            "üé∏ *Demyx shrugs.* 'No tracks to jam with, dude!'"
        )
        return

    sound_file = random.choice(sound_files)
    sound_path = os.path.join(sound_dir, sound_file)

    try:
        vc = await voice_channel.connect()
        await interaction.response.send_message(
            f"üé∂ *Demyx pops into {voice_channel.name}.* 'Let‚Äôs jam!' üéµ Now playing: `{sound_file}`"
        )

        # Make sure FFmpeg is detected
        if not os.path.exists("bin/ffmpeg.exe") and os.name == "nt":
            print("‚ö†Ô∏è FFmpeg not found ‚Äî attempting to use system installation.")

        source = FFmpegPCMAudio(sound_path)
        vc.play(source)
        print(f"üéµ Started playing: {sound_path}")

        while vc.is_playing():
            await asyncio.sleep(1)

        print("‚úÖ Finished playing, disconnecting...")
        await vc.disconnect()
        await interaction.followup.send(
            "üé§ *Demyx waves.* 'Okay, okay, that‚Äôs enough music for now!'"
        )

    except Exception as e:
        print(f"‚ö†Ô∏è Playback error: {e}")
        await interaction.response.send_message(
            f"‚ö†Ô∏è *Demyx scratches his head.* 'Something went wrong playing the sound. ({e})'"
        )


@tree.command(name="joke", description="Demyx tells a joke trying to be funny")
async def joke(interaction: discord.Interaction):
    joke_text = fetch_joke()
    emote = random.choice(JOKE_EMOTES)
    await interaction.response.send_message(f"üòÇ **Random Joke** üòÇ\n{joke_text}\n{emote}")

@tree.command(name="roast", description="Demyx roasts someone brutally üî•")
@app_commands.describe(user="Mention the user you want Demyx to roast")
async def roast(interaction: discord.Interaction, user: discord.Member = None):
    target = user.mention if user else interaction.user.mention

    # 5% chance that Demyx roasts himself instead
    if random.randint(1, 20) == 1:
        self_roasts = [
            "Guess what? I just insulted myself in tune. That‚Äôs talent, baby!",
            "Wow... I can‚Äôt believe I said that out loud. My therapist‚Äôs gonna love this one.",
            "Dang, I just burned myself harder than Axel ever could.",
            "You know you‚Äôve hit rock bottom when your own jokes start hurting you.",
            "...Okay, that one actually stung a bit. Even for me."
        ]
        roast_line = random.choice(self_roasts)
        await interaction.response.send_message(
            f":DemyxRoast: *Demyx winces mid-strum.*\n{roast_line}"
        )
        return

    # Normal roast with mention
    roast_line = random.choice(DEMYX_ROASTS)
    await interaction.response.send_message(
        f":DemyxRoast: *Demyx smirks and strums his sitar...*\n{target}, {roast_line}"
    )


@tree.command(name="fadeout", description="Demyx clears the chat ‚Äî like a melody fading away.")
@app_commands.describe(amount="How many recent messages to fade out (default: 10).")
@commands.has_permissions(manage_messages=True)
async def fadeout(interaction: discord.Interaction, amount: int = 10):
    """Deletes a specified number of recent messages ‚Äî admin/mod only."""
    if not interaction.user.guild_permissions.manage_messages:
        await interaction.response.send_message("üé∏ *Demyx strums lazily.* 'Whoa there, rockstar. Only the band leaders get to fade the crowd out.'", ephemeral=True)
        return

    try:
        await interaction.channel.purge(limit=amount + 1)
        await interaction.response.send_message(f"üé∂ *Demyx grins.* 'And just like that... {amount} messages fade into silence.'", ephemeral=True)
    except Exception as e:
        await interaction.response.send_message(f"‚ö†Ô∏è *Demyx winces.* 'Something went flat ‚Äî I couldn‚Äôt fade those out.'\n`{e}`", ephemeral=True)   

@tree.command(name="soundcheck", description="Demyx does a soundcheck... eventually.")
async def soundcheck(interaction: discord.Interaction):
    # Demyx's self-answering "trivia" rants
    demyx_bits = [
        "üé∂ You ever notice how everyone‚Äôs always fighting and I‚Äôm just‚Äîvibing? Yeah. That‚Äôs balance, baby.",
        "üíß Is it really procrastination if I *intend* to do it later? Thought so.",
        "üé∏ What‚Äôs the secret to sounding good? Easy ‚Äî just play loud enough that nobody can tell you missed a note.",
        "üò¥ Why rehearse when you can just *feel* the music? ‚Ä¶Or nap. Napping works too.",
        "üé§ Who needs a heart when you‚Äôve got rhythm? Well, okay, hearts are nice too, but rhythm‚Äôs less dramatic.",
        "üéµ You ever think about how water has no shape, but still *flows*? Kinda like my work ethic.",
        "üí¶ What‚Äôs my warmup routine? Oh, you mean pretending to tune the sitar while stalling? Classic.",
        "üé∂ Why fight Heartless when you can drown them in good vibes? Oh wait‚ÄîXemnas said that‚Äôs not ‚Äòproductive.‚Äô",
        "üé∏ You know, some people train for years to master their craft. Me? I wing it and hope the audience‚Äôs standards are low.",
        "üé§ Do I take requests? Yeah ‚Äî requests to stop talking, usually.",
        "üéµ Ever try to play a song underwater? Don‚Äôt. Just trust me on that one.",
        "üíß They say ‚Äòmusic heals the heart.‚Äô Cool, guess I‚Äôm a doctor now!",
        "üé∂ Every day‚Äôs a performance, right? Mine just has‚Ä¶ fewer people clapping.",
        "üé∏ Can‚Äôt spell ‚Äòmelodious‚Äô without ‚Äòme.‚Äô Well, you can, but it‚Äôs not as fun.",
        "üé§ I asked Xigbar to be my hype man once. He said I needed fans first. Rude."
    ]

    banter_openers = [
        "üé§ Alright, alright‚Ä¶ let‚Äôs get this soundcheck rolling!",
        "üé∂ Testing, testing... okay, yeah, still awesome.",
        "üí¶ Is this thing on? Oh, right, it‚Äôs *me* ‚Äî so yeah, obviously it is.",
        "üé∏ Time for another world-class performance nobody asked for!",
        "üòé Ladies, gents, and Nobodies ‚Äî Demyx in the house!"
    ]

    lazy_excuses = [
        "üò¥ Ehh, you know what? Not today. The vibes aren‚Äôt aligned.",
        "üí§ Soundcheck canceled ‚Äî my inspiration just‚Ä¶ evaporated.",
        "üíß Sorry, can‚Äôt. My sitar‚Äôs emotionally unavailable right now.",
        "üé∏ Soundcheck? Nah, too mainstream.",
        "üôÉ Let‚Äôs skip it. I‚Äôm on my break. Again.",
        "üò™ I'm too tired for you, ask me when I feel like answering.\n*...which could be never üò¥*"
    ]

    # 1-in-5 chance Demyx refuses to do anything
    if random.randint(1, 5) == 1:
        excuse = random.choice(lazy_excuses)
        await interaction.response.send_message(excuse)
        return

    opener = random.choice(banter_openers)
    lines = random.sample(demyx_bits, k=3)
    performance = f"{opener}\n\n" + "\n".join(lines) + "\n\nüé∂ Soundcheck complete ‚Äî nailed it (probably)."
    await interaction.response.send_message(performance)


@tree.command(name="setlist", description="üé∏ Demyx shows off his full command setlist!")
async def setlist(interaction: discord.Interaction):
    """Displays all available Demyx commands in a fun, musical format."""
    embed = discord.Embed(
        title="üéµ Demyx‚Äôs Setlist üéµ",
        description="Here‚Äôs what Demyx can do when he‚Äôs *in the groove!*",
        color=discord.Color.teal()  # Aqua/turquoise theme for Demyx
    )

    embed.add_field(
        name="üé∂ /play",
        value="Demyx joins your voice channel and plays a random soundboard clip.",
        inline=False
    )
    embed.add_field(
        name="üòÇ /joke",
        value="Demyx tells a random joke ‚Äî whether it‚Äôs funny or not is debatable.",
        inline=False
    )
    embed.add_field(
        name="üî• /roast",
        value="Demyx roasts you or a tagged user mercilessly. 5% chance he roasts himself instead.",
        inline=False
    )
    embed.add_field(
        name="üí® /fadeout",
        value="Moderators only ‚Äî clears a number of recent messages, like a melody fading away.",
        inline=False
    )
    embed.add_field(
        name="üé∏ /soundcheck",
        value="Demyx rambles through his random music-flavored wisdom.",
        inline=False
    )
    embed.add_field(
        name="üèì /ping",
        value="Check if Demyx is alive and jamming.",
        inline=False
    )

    embed.add_field(
        name="üìÖ Bonus:",
        value="Demyx also posts a new joke every morning at **9 AM sharp!** ‚òÄÔ∏è",
        inline=False
    )

    embed.set_footer(text="üíß Stay hydrated, stay lazy ‚Äî Demyx out!")
    await interaction.response.send_message(embed=embed)


@tree.command(name="ping", description="Check if the bot is alive")
async def ping(interaction: discord.Interaction):
    await interaction.response.send_message("Dance Watah Dance")


if __name__ == "__main__":
    DISCORD_TOKEN = os.getenv("DISCORD_TOKEN")
    if not DISCORD_TOKEN:
        print("Missing DISCORD_JOKE_TOKEN environment variable.")
    else:
        bot.run(DISCORD_TOKEN)

        

















